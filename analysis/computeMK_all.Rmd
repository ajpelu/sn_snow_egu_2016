---
title: "Compute Mann-Kendall Theil Sen of snow cover"
author: "AJ Perez-Luque (@ajpelu); FJ Bonet; J Herrero and R. Perez-Perez"
date: "2016 Jaunary"
output:  
    md_document:
      variant: markdown_github
---
## Mann-Kendal Seil Slope analysis for annual and monthly data

### Annual data

```{r metadata, echo=FALSE}
################################################################
# Set working directory 

machine <- 'ajpelu'
# machine <- 'ajpeluLap'
di <- paste('/Users/', machine, '/Dropbox/MS/CONGRESO_EGU2016/sn_snow_egu_2016', sep='')
################################################################
```

En primer lugar leemos los datos
```{r packages, warning=FALSE}
################################################################
# Load packages 
library("wq")
library("zoo")
library("reshape2")
library("stringr")
library("dplyr")
################################################################

################################################################
# Read data

# Get file names
myfiles <- list.files(path = paste(di, "/data/raw/", sep=""), pattern = "\\.csv$")

# Loop to read files 
for (j in myfiles){ 
  aux <- read.csv(file=paste(di, "/data/raw/", j, sep= ""),
              header = TRUE,
              sep = ',')
  name_aux <- str_replace(j, "\\..*", "") 

  assign(name_aux, aux)
}

# Join Wimmed data
join_aux1 <- inner_join(PnXpxXyear, PorcPnXpxXyear, by=c('id','year'))
join_aux2 <- inner_join(PXpxXyear, TXpxXyear, by=c('id','year'))
join_aux3 <- inner_join(join_aux1, join_aux2, by=c('id','year'))

# Set rigth names
names(join_aux3)[1] <- "nie_malla_modi_id"
names(snow_sn)[3] <- "year"

# Join with snow data
mydf <- inner_join(snow_sn, join_aux3, by=c("nie_malla_modi_id", "year"))

# remove temp files
rm(join_aux1, join_aux2, join_aux3)
```

A continuación creamos un bucle para obtener de cada indicador la tendencia y la pendiente. Aplicamos la técnica de Mann-Kendall-Theil-Sen. El bucle realiza las siguientes operaciones: 

* Crea una variable con los indicadores para el bucle. 
* Realiza un subset de datos con los valores del indicador para cada pixel. Obtenemos una serie de datos por cada pixel. 
* Calculamos la tendencia y la pendiente
* Guardamos los resultamos como csv (uno por cada indicador, ver `./data/derived/`)

```{r}
# Loop to compute the MKT by indicator

# Define name of indicators (see variables names)
indicadores <- c("scd", "scod", "scmd", "scmc", "pre", "pre_snow", "pre_snow_per", "temp")

# subset by indicator
for (j in indicadores){ 
  # Create a subset by indicator
  subdf <- mydf[, names(mydf) %in% c("nie_malla_modi_id", "year", j )]
  
  # Manipule data. Transpose 
  # la funcion aggregate es porque tenemos duplicados 
  aux <- dcast(subdf, year ~ nie_malla_modi_id, value.var = j, fun.aggregate = mean) 

  # Create a zoo object 
  auxts <- zoo(aux[-1],aux[,1])
  
  # Compute Mann Kendall and Theil 
  theil <- mannKen(as.ts(auxts))
  
  # Prepare data output
  theil <- as.data.frame(theil)
  
  theil_df <- theil %>% 
    mutate(nie_malla_modi_id = as.numeric(rownames(theil))) %>%
    mutate(sen_slope = round(sen.slope, 3),
           sen_slope_per = round(sen.slope.pct, 2),
           p_value = round(p.value, 5),
           tau = round(tau, 3)) %>%
    dplyr::select(nie_malla_modi_id, sen_slope, sen_slope_per, p_value, tau)
  
  # As data.frame
  theil_df <- as.data.frame(theil_df)
  
  # Rename variables adding dataframe name
  
  # Create vector of new names 
  new_names <- c(paste(names(theil_df), j ,sep='_'))
  
  theil_rename <- theil_df %>% rename_(.dots = setNames(names(.), new_names)) %>%
    dplyr::select(nie_malla_modi_id = starts_with("nie_malla_modi_id"), everything())
  
  # Write table 
  write.table(assign(j, theil_rename), file=paste(di, "/data/derived/", j, ".csv", sep=""), row.names=FALSE, sep=',')
  
  # Check Results. Get the pixel with NA in pvalue. Save results
  aux_na <- theil_df[!complete.cases(theil_df),]
  aux_na$var <- rep(j,nrow(aux_na))
  write.table(aux_na[,c("nie_malla_modi_id","var")], file=paste(di, "/data/derived/na_", j, ".csv", sep=""), row.names=FALSE, sep=',')
} 
```


## Monthly data 

```{r}
my_var <- c('P_n', 'Pre', 'T_m')  

for (i in my_var){ 

# Get file names
myfiles_month <- list.files(path = paste(di, "/data/raw_month/", sep=""), pattern = paste0("(.*", i, ")"))

# Create a auxiliar file to store all monthly data by variable
superauxiliar <- c() 

# Loop to read files 
for (j in myfiles_month){ 
  aux <- read.csv(file=paste(di, "/data/raw_month/", j, sep= ""),
              header = TRUE,
              sep = ',')
  name_aux <- str_replace(j, "\\..*", "") 
  
  ### Create a variable with the name of the month 
  aux$month <- paste0('m', str_extract_all(j, "\\d+")) 
  
  
  #aux_name <- str_replace(j, "(.*month)","")
  #aux_month <- as.numeric(str_replace(aux_name, "\\..*", ""))
  #aux$month <-  aux_month
  
  # Change name of some variables
  names(aux)[1] <- 'nie_malla_modi_id'
  names(aux)[3] <- 'year' 
  
  # Select only pixel matching snow_cover 
  aux <- aux[aux$nie_malla_modi_id %in% snow_sn$nie_malla_modi_id, ]
  
  # Remove data from 2015 and 2000  
  aux <- aux %>% 
    filter(year < 2015) %>%
    filter(year > 2000)

  # Store as object 
  superauxiliar <- rbind(superauxiliar, aux)
  name_superauxiliar <- i 
  assign(name_superauxiliar, superauxiliar)
}
 
}


# Aggregate value by season: 
# winter = 1,2,3 
# spring = 4,5,6 
# summer = 7,8,9
# autumn = 10,11,12 

# Temperature data 
temp_monthly <- as.data.frame(dcast(T_m, nie_malla_modi_id + year ~ month, value.var = "T_m"))

temp_season4 <- temp_monthly %>% 
  group_by(nie_malla_modi_id, year) %>% 
  summarise(wi = mean(m01,m02,m03),
         sp = mean(m04,m05,m06),
         su = mean(m07,m08,m09),
         au = mean(m10,m11,m12)) 

# Join data 

tempSeas <- temp_monthly %>% 
  inner_join(temp_season4, by=c("nie_malla_modi_id","year"))
## 


# Precipitation data
pre_monthly <- as.data.frame(dcast(Pre, nie_malla_modi_id + year ~ month, value.var = "Pre"))

pre_season4 <- pre_monthly %>% 
  group_by(nie_malla_modi_id, year) %>% 
  summarise(wi = sum(m01,m02,m03),
         sp = sum(m04,m05,m06),
         su = sum(m07,m08,m09),
         au = sum(m10,m11,m12)) 

# Join data 
preSeas <- pre_monthly %>% 
  inner_join(pre_season4, by=c("nie_malla_modi_id","year"))
## 




# Precipitation data
pn_monthly <- as.data.frame(dcast(P_n, nie_malla_modi_id + year ~ month, value.var = "P_n"))

pn_season4 <- pn_monthly %>% 
  group_by(nie_malla_modi_id, year) %>% 
  summarise(wi = sum(m01,m02,m03),
         sp = sum(m04,m05,m06),
         su = sum(m07,m08,m09),
         au = sum(m10,m11,m12)) 

# Join data 
pnSeas <- pn_monthly %>% 
  inner_join(pn_season4, by=c("nie_malla_modi_id","year"))
## 


















str_extract_all("T_mXpxXyear_month02.csv", "\\d+")

myfiles_month[1]

x1 <- read.csv(file=paste(di, "/data/raw_month/", myfiles_month[1], sep= ""),
              header = TRUE,
              sep = ',')
x1$month <- 1

x2 <- read.csv(file=paste(di, "/data/raw_month/", myfiles_month[2], sep= ""),
              header = TRUE,
              sep = ',')

x2$month <- 2

x3 <- read.csv(file=paste(di, "/data/raw_month/", myfiles_month[3], sep= ""),
              header = TRUE,
              sep = ',')

x3$month <- 3


x4 <- read.csv(file=paste(di, "/data/raw_month/", myfiles_month[4], sep= ""),
              header = TRUE,
              sep = ',')

x4$month <- 4

x5 <- read.csv(file=paste(di, "/data/raw_month/", myfiles_month[5], sep= ""),
              header = TRUE,
              sep = ',')

x5$month <- 5

x6 <- read.csv(file=paste(di, "/data/raw_month/", myfiles_month[6], sep= ""),
              header = TRUE,
              sep = ',')

x6$month <- 6

x7 <- read.csv(file=paste(di, "/data/raw_month/", myfiles_month[7], sep= ""),
              header = TRUE,
              sep = ',')

x7$month <- 7

x8 <- read.csv(file=paste(di, "/data/raw_month/", myfiles_month[8], sep= ""),
              header = TRUE,
              sep = ',')

x8$month <- 8



x9 <- read.csv(file=paste(di, "/data/raw_month/", myfiles_month[9], sep= ""),
              header = TRUE,
              sep = ',')

x9$month <- 9



xx <- rbind(x1, x2, x3, x4, x5, x6, x7,x8,x9)

temp_xx <- dcast(xx, Id.px + Year ~ month, value.var = "T_m") 





TXpxXyear[TXpxXyear$id == 1675994, ]
table(TXpxXyear$year)





my_var <- c('P_n', 'Pre', 'T_m')  



ms <- list.files(path = paste(di, "/data/raw_month/", sep=""), pattern = "(P_n)")
  
  

jj <- str_replace(j, "(.*month)","")
jjj <- str_replace(jj, "\\..*", "")
