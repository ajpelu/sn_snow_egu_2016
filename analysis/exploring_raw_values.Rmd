---
title: "Explore raw values of snow-cover indicators"
author: "AJ Perez-Luque (@ajpelu); FJ Bonet; J Herrero and R. Perez-Perez"
date: "2016 March"
output:
  md_document:
      variant: markdown_github
---

```{r metadata, echo=FALSE}
# Set working directory 

# machine <- 'ajpelu'
machine <- 'ajpeluLap'
di <- paste('/Users/', machine, '/Dropbox/MS/CONGRESO_EGU2016/sn_snow_egu_2016', sep='')
```

```{r packages, warning=FALSE, message=FALSE}
# Load packages 
library("raster")
library("rgdal")
library("sp")
library("plyr")
library("dplyr")
library("rasterVis") 
library("multcomp")
library("broom") # tidy output models
library("grid") # multiple plots
library("gridExtra") # multiple plots
library("ggplot2")
library("GGally")
library("pander")
library("mclust")
source("http://www.highstat.com/BGS/GAM/RCode/HighstatLibV8.R")
source(paste0(di,"/R/exportpdf.R")) # function to export raster levelplots maps as pdf
```

```{r, code=readLines(paste(di,'/R/autocaption.R', sep='')), echo=FALSE}
```


## Prepare Data

* Read snow cover indicator data and subset snow cover duration 
* Read topographic data and position (spatial) data
* Read region data (hydrological basins)

```{r}
# Read data (snow cover)
snow <- read.csv(file=paste(di, "/data/raw/snow_sn.csv", sep= ""), header = TRUE) 
# --   

# Read spatial data and Get lat/long
centroides <- rgdal::readOGR(dsn=paste(di, "/data/geoinfo", sep=""),
                             layer = "centroides_selected", verbose = FALSE)
# Select only attributes of interest and rename them
centroides <- centroides[c("id")]

# Create lat/lng by id 
xycentroides <- cbind(centroides@data, coordinates(centroides))
names(xycentroides) <- c("nie_malla_modi_id", "lon","lat")

xycentroides <- filter(xycentroides, nie_malla_modi_id %in% snow$nie_malla_modi_id)

# -- 

# Read Topographic data 
rawtopo <- read.csv(file=paste(di, "/data/topo_nie_malla_modis.csv", sep=""),
                    header=TRUE,
                    sep = ",") 
# function to convert radian to degree 
rad2deg <- function(rad) {(rad * 180) / (pi)} 


topo <- rawtopo %>% 
  filter(id %in% snow$nie_malla_modi_id) %>% 
  mutate(nie_malla_modi_id = id, 
         slope50mean_deg = rad2deg(slope50mean),
         slope50median_deg = rad2deg(slope50median),
         aspect50mean_deg = rad2deg(aspect50mean),
         aspect50median_deg = rad2deg(aspect50median)) %>%
  dplyr::select(nie_malla_modi_id, dem50mean, dem50median, slope50mean_deg, 
                slope50median_deg, aspect50mean_deg, aspect50median_deg) 
# -- 

## Hydrological basin 
basin <- read.csv(file=paste(di, "/data/derived/pixel_region.csv", sep=""),
                    header=TRUE,
                    sep = ",") 
# --


# Create objects with basis statistics for all indicators 
indicadores <- c("scd", "scod", "scmd", "scmc") 

# Loop to create objects with basis stats
for (i in indicadores) { 
  vnames <- c("nie_malla_modi_id", i) 
  aux <- snow %>%
    dplyr::select(one_of(vnames)) %>%
    mutate_(vinterest = i) %>%
    group_by_("nie_malla_modi_id") %>%
    summarise(mean=mean(vinterest),
              sd = sd(vinterest),
              cv = raster::cv(vinterest),
              se = sd / sqrt (length(vinterest))) %>%
    inner_join(topo, by="nie_malla_modi_id") %>%
    inner_join(xycentroides, by="nie_malla_modi_id") %>%
    inner_join(basin, by="nie_malla_modi_id")
  
  assign(i, aux)
} 

```




```{r echo=FALSE}
# Set theme ggplot options
mythemeggplot <- theme_bw() + theme(panel.grid.major=element_blank(),
                       panel.grid.minor=element_blank(),
                       strip.background=element_rect(fill='white'))
```


## Elevation filter 

* Explore the range of elevation to set the filter
* Explore elevation by hydrological basin 

```{r, echo=FALSE, fig.cap=fig$cap("elev_filter", "Profile of elevation"), fig.height=8 , fig.width=8}

# Get quantiles based on scd 
x <- as.data.frame(round(quantile(scd$mean, probs = seq(0, 1, 0.1))))
x$per <- rownames(x) 
names(x)[1] <- 'q'

# Get quantiles based on elevation
xe <- as.data.frame(round(quantile(scd$dem50mean, probs = seq(0, 1, 0.1))))
xe$per <- rownames(xe) 
names(xe)[1] <- 'q'

# pdf(file="elevation.pdf", height = 10, width = 10)
ggplot(scd, aes(x=dem50mean, y=mean)) + 
  geom_hline(yintercept=x$q, col='blue') +
  geom_label(data=x, aes(x=3700, y=q), label=x$per, colour='blue') +
  geom_label(data=x, aes(x=4000, y=q), label=x$q, colour='blue') +
  geom_vline(xintercept = xe$q, col='red') + 
  geom_label(data=xe, aes(x=q, y=210), label=xe$per, colour='red') +
  geom_point() +  
  mythemeggplot + 
  xlab('Elevation') + ylab('Snow cover duration (days)') + 
  ylim(0,225) + xlim(0,4000)
# dev.off()
```

# See changes of SCD by elevation
```{r, echo=FALSE, results='hide'}
scd1000 <- scd %>% 
  dplyr::filter(dem50mean < 1000)

lm1000 <- lm(mean~dem50mean, data=scd1000)
summary(lm1000)

# Increment of scd by 100 
coef(lm1000)[2] * 100 



scd2000 <- scd %>% 
  dplyr::filter(dem50mean >= 1000) %>% 
  dplyr::filter(dem50mean < 2000)

lm2000 <- lm(mean~dem50mean, data=scd2000)
summary(lm2000)


# Increment of scd by 100 
coef(lm2000)[2] * 100 


scd3000 <- scd %>% 
  dplyr::filter(dem50mean >= 2000) %>% 
  dplyr::filter(dem50mean < 3000)

lm3000 <- lm(mean~dem50mean, data=scd3000)
summary(lm3000)

# Increment of scd by 100 
coef(lm3000)[2] * 100 

scd4000 <- scd %>% 
  dplyr::filter(dem50mean > 3000) 

lm4000 <- lm(mean~dem50mean, data=scd4000)
summary(lm4000)

# Increment of scd by 100 
coef(lm4000)[2] * 100 


# Above 1000 
scdxx <- scd %>% 
  dplyr::filter(dem50mean > 1000) 

lmxx <- lm(mean~dem50mean, data=scdxx)
summary(lmxx)

# Increment of scd by 100 
coef(lmxx)[2] * 100 

rate <- data.frame(
  elev = c('<1000', '1000 - 2000', '2000-3000', '>3000', '>1000'),
  scd_change = c(coef(lm1000)[2] * 100, 
                 coef(lm2000)[2] * 100,
                 coef(lm3000)[2] * 100,
                 coef(lm4000)[2] * 100,
                 coef(lmxx)[2] * 100))  
pander(rate)
```

```{r}
ggplot(scd, aes(x=dem50mean, y=mean)) + 
  geom_point() +  
  mythemeggplot + 
  xlab('Elevation (m)') + ylab('SCD (days)') + 
  ylim(0,225) + xlim(0,4000)
```



* Select the pixels above 14 days (scd) 

```{r}
scdfilter <- scd %>% filter(mean > 14)

ggplot(scd, aes(x=dem50mean, y=mean)) + 
  geom_point() + mythemeggplot + 
  geom_point(data=scdfilter, aes(dem50mean, mean), col='blue') + 
  geom_vline(xintercept = 1250, col='red') 

# How many pixels (from filter data) are above 1250 m? 
(nrow(subset(scdfilter, dem50mean > 1250))/nrow(scdfilter))*100 
```



```{r, echo=FALSE, fig.cap=fig$cap("elev_filter_basin", "Profile of elevation by basin"), fig.height=6 , fig.width=15}
# Explore elevation by hydrological basin 
ggplot(scd, aes(x=dem50mean, y=mean)) + 
  geom_point(size=.5) +  
  facet_wrap(~basin_name, nrow = 1) +
  mythemeggplot + 
  xlab('Elevation') + ylab('Snow cover duration (days)') 
```



```{r, echo=FALSE, fig.cap=fig$cap("elev_filter_basin_col", "Profile of elevation by basin"), fig.height=6 , fig.width=15}
g <- ggplot(scd, aes(x=dem50mean, y=mean)) + 
  geom_point(col='grey') + mythemeggplot + 
  xlab('Elevation') + ylab('Snow cover duration (days)') 

ad <- g + geom_point(data=subset(scd, basin_name == 'Adra'), aes(dem50mean, mean), col='blue') +
  annotate("text", x = 500, y = 200, label = "Adra")
an <- g + geom_point(data=subset(scd, basin_name == 'Andarax'), aes(dem50mean, mean), col='blue') +
  annotate("text", x = 500, y = 200, label = "Andarax")
fa <- g + geom_point(data=subset(scd, basin_name == 'Fardes'), aes(dem50mean, mean), col='blue') +
  annotate("text", x = 500, y = 200, label = "Fardes")
ge <- g + geom_point(data=subset(scd, basin_name == 'Genil'), aes(dem50mean, mean), col='blue') +
  annotate("text", x = 500, y = 200, label = "Genil")
gu <- g + geom_point(data=subset(scd, basin_name == 'Guadalfeo'), aes(dem50mean, mean), col='blue') + 
  annotate("text", x = 500, y = 200, label = "Guadalfeo")

grid.arrange(ad, an, fa, ge, gu, nrow=1)
```


### Spatial pattern of the snowcover indicators 

* Create raster maps of the summary stats for each indicator (`$indicator$`: `scd`, `scod`, `scmd`, `scmc`). Two raster maps will be created:
  
  * `r_mean_$indicator$`: mean values of the indicator for the pixel in the temporal serie.
  * `r_cv_$indicator$`: coefficient of variation of the indicator for the pixel in the temporal serie.

* Two additional raster maps will be created, with a mask of the elevation (those pixels above 1000 *m asl*). The names of the raster are: `r_mean_$indicator$_1000` and `r_cv_$indicator$_1000`. Pixels below 1000 masl show a value of `0`. This value can be customized (change `updatevalue=-1` argument of the `mask` function). 

* All these rasters are stored at `./data/derived/` 

```{r} 
# Spatial data
# Reproject to utm and m
centroides <- spTransform(centroides, CRS("+init=epsg:23030"))

# Get projection 
projection(centroides) 

# Select only attributes of interest and rename them
centroides <- centroides[c("id")]
names(centroides) <-"nie_malla_modi_id"

# Which pixels are in the snow object
pix_comunes <- match(snow$nie_malla_modi_id, centroides$nie_malla_modi_id)

# Create spatial objetc with centroid of Sierra Nevada
centroides_sn <- centroides[pix_comunes,]

# elevation filter
el <- '1250'
el_numeric <- 1250

# Loop to create raster map 
for (i in indicadores) { 
  df <- get(i)
  
  # merge MKT and spatial pixel 
  aux_spatial <- sp::merge(x=centroides_sn, y=df, by="nie_malla_modi_id")
  aux_spatial_elev <- aux_spatial[c("nie_malla_modi_id", "dem50mean")]
  
  # raster auxiliar 
  aux_rast <- raster(aux_spatial, resolution=500)
  
  # raster of Mean values 
  mean_raster <- rasterize(aux_spatial, aux_rast, "mean", fun=mean)
  names(mean_raster) <- i # Set name of the raster layer 
  
  # raster of CV values
  cv_raster <- rasterize(aux_spatial, aux_rast, "cv", fun=mean)
  names(cv_raster) <- i 
  
  # raster of Elevation
  elev_raster <- rasterize(aux_spatial_elev, aux_rast, "dem50mean", fun=mean)
  # Fitler by elevation threshold 
  elev_raster_filtro <- elev_raster
  elev_raster_filtro[elev_raster_filtro < el_numeric] <- NA
  
  # name_elev_raster <- paste("elev_raster", el, sep='')
  # assign(name_elev_raster, elev_raster)

  # valid old
  ## elev_raster1000 <- elev_raster
  ## elev_raster1000[elev_raster1000 < 1000] <- NA
  
  # Mask by 1000
  mean_raster_filtro <- mask(mean_raster, elev_raster_filtro, updatevalue=-1)
  cv_raster_filtro <- mask(cv_raster, elev_raster_filtro, updatevalue=-1)
  
  # mean_raster1000 <- mask(mean_raster, elev_raster1000, updatevalue=0)
  # cv_raster1000 <- mask(cv_raster, elev_raster1000, updatevalue=0)
  
  
  # assign 
  name_mean <- paste("r_mean_",i, sep="")
  name_cv <- paste("r_cv_",i, sep="")
  name_mean_filtro <- paste("r_mean_",i,"_",el, sep="")
  name_cv_filtro <- paste("r_cv_",i,"_",el, sep="")
  
  assign(name_mean, mean_raster)
  writeRaster(mean_raster, file=paste(di, "/data/derived/r_mean_", i, ".asc", sep=""), overwrite=TRUE)
  
  assign(name_cv, cv_raster)
  writeRaster(cv_raster, file=paste(di, "/data/derived/r_cv_", i, ".asc", sep=""), overwrite=TRUE)
  
  assign(name_mean_filtro, mean_raster_filtro)
  writeRaster(mean_raster_filtro, file=paste(di, "/data/derived/r_mean_", i, "_", el, ".asc", sep=""), overwrite=TRUE)
  
  assign(name_cv_filtro, cv_raster_filtro)
  writeRaster(cv_raster_filtro, file=paste(di, "/data/derived/r_cv_", i, "_", el, ".asc", sep=""), overwrite=TRUE)
}
```

## Visualization of the Snow Cover indicators 

For each indicator we plot several maps. See `/images/raster_maps/`

### Snow Cover Duration

```{r, echo=FALSE, fig.cap=fig$cap("scd_mean", "Mean values of Snow cover duration"), fig.height=8 , fig.width=11}

# Select a palette
# http://colorbrewer2.org/
# mypal <- brewer.pal(9, "Blues")
# Add a colour for 0 value
# mypal <- c("#D2D2D2", mypal)

mypal <- c("#D2D2D2", "#C6DBEF", "#9ECAE1", "#6BAED6", "#4292C6", "#2171B5", "#08519C", "#08306B")

# Specify the color palette
myTheme=rasterTheme(region=mypal)
# myTheme$panel.background$col <- 'gray'

# Mean plot
lp <- levelplot(r_mean_scd_1250, 
          par.settings=myTheme, margin=list(axis=TRUE), colorkey=TRUE,
          # Contour options
          contour=TRUE, labels=TRUE, pretty=TRUE, 
          # Breaks
          at=c(-1,seq(0,225,by=25)),
          main="Snow Cover Duration (mean values, days)")
print(lp)

exportpdf(mypdf=paste0(di, '/images/raster_maps/r_mean_scd_', el, '.pdf'), lp) 


## Lat long 

# Auxiliar layer for Reproject the maps 
aux_project <- rgdal::readOGR(dsn=paste(di, "/data/geoinfo", sep=""),
                             layer = "centroides_selected", verbose = FALSE)

crs_aux_project <- projection(aux_project)

## Boundaries SN 
enp <- rgdal::readOGR(dsn=paste("/Users/", machine, "/Dropbox/carto_public/EENNPP/InfGeografica/InfVectorial/Shapes/ED50_30", sep=""),
                      layer = "EENNPP", verbose = FALSE)
# Subset limits of SN                      
sn <- subset(enp, NOMBRE == 'SIERRA NEVADA' & FIGURA == 'Espacio Natural')

# Reproject limits
sn_re <- spTransform(sn, CRS(crs_aux_project))


r_mean_scd_1250_repro <- projectRaster(r_mean_scd_1250, crs=crs(aux_project))



lp <-levelplot(r_mean_scd_1250_repro, 
          par.settings=myTheme, margin=list(axis=TRUE), colorkey=TRUE,
          # Contour options
          contour=TRUE, labels=TRUE, pretty=TRUE, 
          # Breaks
          at=c(-1,seq(0,225,by=25)),
          main="Snow Cover Duration (mean values, days)") 
# + latticeExtra::layer(sp.polygons(sn_re))

print(lp)

exportpdf(mypdf=paste0(di, '/images/raster_maps/r_mean_scd_1250_lat_long.pdf'), lp) 

```



```{r, echo=FALSE, fig.cap=fig$cap("scd_cv", "Coefficient of Variation of values of Snow cover duration"), fig.height=8 , fig.width=11}
# CV plot
mypal_cv <- brewer.pal(9, "Oranges")
mypal_cv <- c("#D2D2D2", mypal_cv)

myTheme_cv=rasterTheme(region=mypal_cv)

lp <- levelplot(r_cv_scd_1250, 
          par.settings=myTheme_cv, margin=list(axis=TRUE), colorkey=TRUE, 
          contour=TRUE, labels=TRUE, pretty=TRUE, 
          # Breaks
          at=c(-1, seq(0,maxValue(r_cv_scd_1250),by=20)),
          main="Snow Cover Duration (CV)")
print(lp)
exportpdf(mypdf=paste0(di, '/images/raster_maps/r_cv_scd_', el, '.pdf'), lp) 
  

```



### Snow Cover Onset Date

```{r, echo=FALSE, fig.cap=fig$cap("scod_mean", "Mean values of Snow cover Onset Date"), fig.height=8 , fig.width=11}

# Select a palette
# http://colorbrewer2.org/
mypal <- brewer.pal(9, "YlOrRd")
# Add a colour for 0 value
mypal <- c("#D2D2D2", mypal)
# Specify the color palette
myTheme=rasterTheme(region=mypal)


lp <- levelplot(r_mean_scod_1250, 
          par.settings=myTheme, margin=list(axis=TRUE), colorkey=TRUE, 
          # Contour options
          contour=TRUE, labels=TRUE, pretty=TRUE, 
          # Breaks
          #cut=20,
          at=c(-1,seq(15,maxValue(r_mean_scd_1250),by=20)),
          main="Snow Cover Onset Date (mean values, hydrological day)") 
print(lp)
exportpdf(mypdf=paste0(di, '/images/raster_maps/r_mean_scod_1900.pdf'), lp) 
  

lp <- levelplot(r_mean_scod_1250, 
          par.settings=myTheme, margin=list(axis=TRUE), colorkey=TRUE, 
          main="Snow Cover Onset Date (mean values, hydrological day)") 

print(lp)
exportpdf(mypdf=paste0(di, '/images/raster_maps/r_mean_scod_', el, '_non_isolines.pdf'), lp) 

```



```{r, echo=FALSE, fig.cap=fig$cap("scod_cv", "Coefficient of Variation of values of Snow cover Onset date"), fig.height=8 , fig.width=11}
# CV plot
mypal_cv <- brewer.pal(9, "Oranges")
mypal_cv <- c("#D2D2D2", mypal_cv)

myTheme_cv=rasterTheme(region=mypal_cv)

lp <- levelplot(r_cv_scod_1250, 
          par.settings=myTheme_cv, margin=list(axis=TRUE), colorkey=TRUE, 
          contour=TRUE, labels=TRUE, pretty=TRUE, 
          # Breaks
          at=c(-1, seq(0,maxValue(r_cv_scod_1250),by=20)),
          main="Snow Cover Onset Date (CV)")

print(lp)
exportpdf(mypdf=paste0(di, '/images/raster_maps/r_cv_scod_', el, '.pdf'), lp) 
 
```


### Snow Cover Melting Date

```{r, echo=FALSE, fig.cap=fig$cap("scmd_mean", "Mean values of Snow cover Melting Date"), fig.height=8 , fig.width=11}

# Select a palette
# http://colorbrewer2.org/
mypal <- rev(brewer.pal(9, "Greens"))
# Add a colour for 0 value
mypal <- c("#D2D2D2", mypal)
# Specify the color palette
myTheme=rasterTheme(region=mypal)


lp <- levelplot(r_mean_scmd_1250, 
          par.settings=myTheme, margin=list(axis=TRUE), colorkey=TRUE, 
          # Contour options
          contour=TRUE, labels=TRUE, pretty=TRUE, 
          # Breaks
          #cut=20,
          at=c(-1, 0,seq(100,280,by=20)),
          main="Snow Cover Melting Date (mean values, hydrological day)") 

print(lp)
exportpdf(mypdf=paste0(di, '/images/raster_maps/r_mean_scmd_', el, '.pdf'), lp) 
 

lp <- levelplot(r_mean_scmd_1250, 
          par.settings=myTheme, margin=list(axis=TRUE), colorkey=TRUE, 
          main="Snow Cover Melting Date (mean values, hydrological day)", 
          at=c(-1,seq(0,280,by=10)))

print(lp)
exportpdf(mypdf=paste0(di, '/images/raster_maps/r_mean_scmd_', el, '_non_isolines.pdf'), lp) 
```



```{r, echo=FALSE, fig.cap=fig$cap("scmd_cv", "Coefficient of Variation of values of Snow cover Melting date"), fig.height=8 , fig.width=11}
# CV plot
mypal_cv <- brewer.pal(9, "Oranges")
mypal_cv <- c("#D2D2D2", mypal_cv)

myTheme_cv=rasterTheme(region=mypal_cv)

lp <- levelplot(r_cv_scmd_1250, 
          par.settings=myTheme_cv, margin=list(axis=TRUE), colorkey=TRUE, 
          #contour=TRUE, labels=TRUE, pretty=TRUE, 
          # Breaks
          #at=seq(0,50,by=7.5),
          main="Snow Cover Melting Date (CV)")
print(lp)
exportpdf(mypdf=paste0(di, '/images/raster_maps/r_cv_scmd_', el, '.pdf'), lp) 
 
```


### Snow Cover Melting Cycles

```{r, echo=FALSE, fig.cap=fig$cap("scmc_mean", "Mean values of Snow cover Melting Date"), fig.height=8 , fig.width=11}

# Select a palette
# http://colorbrewer2.org/
mypal <- brewer.pal(5, "Purples")
# Add a colour for 0 value
mypal <- c("#D2D2D2", mypal)
# Specify the color palette
myTheme=rasterTheme(region=mypal)


lp <- levelplot(r_mean_scmc_1250, 
          par.settings=myTheme, margin=list(axis=TRUE), colorkey=TRUE, 
          # Contour options
          contour=TRUE, labels=TRUE, pretty=TRUE, 
          # Breaks
          at=seq(0,5,by=1),
          main="Snow Cover Melting cycles (mean values, number)") 
print(lp)
exportpdf(mypdf=paste0(di, '/images/raster_maps/r_mean_scmc_', el, '.pdf'), lp) 

lp <- levelplot(r_mean_scmc_1250, 
          par.settings=myTheme, margin=list(axis=TRUE), colorkey=TRUE, 
          main="Snow Cover Melting cycles (mean values, number)")

print(lp)
exportpdf(mypdf=paste0(di, '/images/raster_maps/r_mean_scmc_', el, '_non_isolines.pdf'), lp) 

```



```{r, echo=FALSE, fig.cap=fig$cap("scmc_cv", "Coefficient of Variation of values of Snow cover Melting cycles"), fig.height=8 , fig.width=11}
# CV plot
mypal_cv <- brewer.pal(9, "Oranges")
mypal_cv <- c("#D2D2D2", mypal_cv)

myTheme_cv=rasterTheme(region=mypal_cv)

lp <- levelplot(r_cv_scmc_1250, 
          par.settings=myTheme_cv, margin=list(axis=TRUE), colorkey=TRUE, 
          contour=TRUE, labels=TRUE, pretty=TRUE, 
          # Breaks
          at=seq(0,maxValue(r_cv_scmc_1250),by=20),
          main="Snow Cover Melting Date (CV)")

print(lp)
exportpdf(mypdf=paste0(di, '/images/raster_maps/r_cv_scmc_', el, '.pdf'), lp) 


```




# Explore patterns of raw values
##  :red_circle: CARPIN!!!!!! TOOOOOOOOOOO

## Snow Cover Onset Dates 

* Analyze the effect of aspect, slope and longtitude on snow cover onset date

```{r, echo=FALSE}
# Subset data and classify elevation and aspect
scod1900 <- scod %>% filter(dem50mean > 1900) %>%
  mutate(dem50mean_group = cut(dem50mean, 
                         breaks = seq(from=0, to=3500, by=250),
                         labels = c("0-250", "251-500","501-750","751-1000",
                                    "1001-1250","1251-1500","1501-1750","1751-2000",
                                    "2001-2250","2251-2500","2501-2750", "2751-3000",
                                    "3001-3250", "3251-3500")),
         aspect50mean_deg_group = cut(aspect50mean_deg, 
                                      breaks= c(22.5, 67.5, 112.5, 157.5, 
                                                202.5, 247.5, 292.5, 337.5, 361),
                                      labels = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))) 


### Model 
m_scod <- glm(mean ~ lon + aspect50mean_deg_group + slope50mean_deg, data=scod1900)

# Remove na level of aspect 
df <- scod1900 %>% na.omit() 

panderOptions('round', 4)
pander(format(tidy(drop1(m_scod, test="Chi")), digits=4))
```

* What about the Variance Inflation factors? 


```{r, echo=FALSE}
# Exploring relationship
pander(as.data.frame(corvif(df[,c('lon','aspect50mean_deg_group','slope50mean_deg')])))
detach(package:pander, unload=TRUE)
```



```{r, message=FALSE, echo=FALSE, fig.cap=fig$cap("ggpair_scod", "Explore relationships of covariates (Snow cover onset dates"), fig.height=12 , fig.width=11}
# See vignettes at GGally package
# See also http://stackoverflow.com/questions/30858337/how-to-customize-lines-in-ggpairs-ggally


# Define a customized lower part
lowerFn <- function(data, mapping, method = "lm", ...) {
  p <- ggplot2::ggplot(data = data, mapping = mapping) +
    ggplot2::geom_point(colour = "gray") +
    ggplot2::geom_smooth(method = method , color = "red", ...)
  p
}

# Plot 
ggpairs(df, 
        columns = c("lon","aspect50mean_deg_group","slope50mean_deg"),
        columnLabels = c('Longitude', 'Aspect', 'Slope'),
        lower = list(continuous = wrap(lowerFn, method="lm"),
                     combo = wrap("facethist", fill="blue")),
        upper = list(continuous = wrap("cor", size=11), combo='box'),
        diag = list(discrete = wrap("barDiag", fill= 'blue'))) +
   theme_bw() 
```        




```{r, echo=FALSE, fig.cap=fig$cap("scod_tukey_aspect", "Snow cover onset dates by aspect"), fig.height=5 , fig.width=7, warning=FALSE, message=FALSE}
# Plot of Snow Cover Onset dates by aspect 

# Compute multiple comparisons 
tuk <- glht(m_scod, linfct = mcp(aspect50mean_deg_group= "Tukey"))
# Convert comparisons into letters 
df_letter <- fortify(cld(tuk)) %>%
  transmute(aspect50mean_deg_group = as.factor(lhs),
         tukey_aspect = letters) 

# Specify theme
mythemeggplot <- theme(panel.grid.major=element_blank(),
                       panel.grid.minor=element_blank(),
                       strip.background=element_rect(fill='white'))
  
# Plot 
ggplot(df, aes(x=aspect50mean_deg_group, y=mean)) +geom_boxplot() + 
  geom_text(data=df_letter, aes(label = tukey_aspect, x=aspect50mean_deg_group, y=100),
           position = position_dodge(width=0.9)) +
  theme_bw() + mythemeggplot + 
  ylab('Snow cover onset date (hydrological day)') +
  xlab('aspect')  
```




```{r echo=FALSE, fig.cap=fig$cap("scod_tukey_aspect_effects", "Snow cover onset dates by aspect (effect sizes"), fig.height=8 , fig.width=11}
# Effects comparison (aspect)
CI <- confint(tuk)

ggplot(mapping = aes(lhs, estimate)) +
  geom_linerange(aes(ymin = lwr, ymax = upr), data = CI) +
  geom_point(aes(size = p), data = summary(tuk)) +
  scale_size(trans = "reverse") + theme_bw() + 
  coord_flip()
```



```{r echo=FALSE, fig.cap=fig$cap("scod_lon_slope", "Snow cover onset dates by Longitude and Slope"), fig.height=5 , fig.width=8}
y_lab <- ylab('Snow cover onset date (hydrological day)') 


x_lab <- xlab('Longitude')
a <- ggplot(scod1900, aes(x=lon, y= mean)) + 
  geom_point(col='gray') + 
  geom_smooth(method='lm') +
  theme_bw() + mythemeggplot + x_lab + y_lab
  
x_lab <- xlab('Slope (degrees)') 
b <- ggplot(scod1900, aes(x=slope50mean_deg, y= mean)) + 
  geom_point(col='gray') + 
  geom_smooth(method='lm') +
    theme_bw() + mythemeggplot + x_lab + y_lab

grid.arrange(a, b, ncol=2)
```

## Snow Cover Melting Dates 

```{r, echo=FALSE}
# Subset data and classify elevation and aspect
scmd1900 <- scmd %>% filter(dem50mean > 1900) %>%
  mutate(dem50mean_group = cut(dem50mean, 
                         breaks = seq(from=0, to=3500, by=250),
                         labels = c("0-250", "251-500","501-750","751-1000",
                                    "1001-1250","1251-1500","1501-1750","1751-2000",
                                    "2001-2250","2251-2500","2501-2750", "2751-3000",
                                    "3001-3250", "3251-3500")),
         aspect50mean_deg_group = cut(aspect50mean_deg, 
                                      breaks= c(22.5, 67.5, 112.5, 157.5, 
                                                202.5, 247.5, 292.5, 337.5, 361),
                                      labels = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))) 


### Model 
m_scmd <- glm(mean ~ dem50mean + lon + aspect50mean_deg_group + slope50mean_deg, data=scmd1900)

# Remove na level of aspect 
df <- scmd1900 %>% na.omit() 

library("pander")
pander(format(tidy(drop1(m_scmd, test="Chi")), digits=4))
```


* What about the Variance Inflation factors? 


```{r, echo=FALSE}
# Exploring relationship
pander(as.data.frame(corvif(df[,c('dem50mean','lon','aspect50mean_deg_group','slope50mean_deg')])))
detach(package:pander, unload=TRUE)
```



```{r, message=FALSE, echo=FALSE, fig.cap=fig$cap("ggpair_scmd", "Explore relationships of covariates (Snow cover melting dates"), fig.height=12 , fig.width=11}
# Plot 
ggpairs(df, 
        columns = c("dem50mean","lon","aspect50mean_deg_group","slope50mean_deg"),
        columnLabels = c('Elevation','Longitude', 'Aspect', 'Slope'),
        lower = list(continuous = wrap(lowerFn, method="lm"),
                     combo = wrap("facethist", fill="blue")),
        upper = list(continuous = wrap("cor", size=11), combo='box'),
        diag = list(discrete = wrap("barDiag", fill= 'blue'))) +
   theme_bw() 
```        



```{r, echo=FALSE, fig.cap=fig$cap("scmd_tukey_aspect", "Snow cover melting dates by aspect"), fig.height=5 , fig.width=7, warning=FALSE, message=FALSE}
# Plot of Snow Cover Melting dates by aspect 

# Compute multiple comparisons 
tuk <- glht(m_scmd, linfct = mcp(aspect50mean_deg_group= "Tukey"))
# Convert comparisons into letters 
df_letter <- fortify(cld(tuk)) %>%
  transmute(aspect50mean_deg_group = as.factor(lhs),
         tukey_aspect = letters) 

# Plot 
ggplot(df, aes(x=aspect50mean_deg_group, y=mean)) +geom_boxplot() + 
  geom_text(data=df_letter, aes(label = tukey_aspect, x=aspect50mean_deg_group, y=135),
           position = position_dodge(width=0.9)) +
  theme_bw() + mythemeggplot +
  ylab('Snow cover onset date (hydrological day)') +
  xlab('aspect') 
```




```{r echo=FALSE, fig.cap=fig$cap("scmd_tukey_aspect_effects", "Snow cover melting dates by aspect (effect sizes"), fig.height=8 , fig.width=11}
# Effects comparison (aspect)
CI <- confint(tuk)

ggplot(mapping = aes(lhs, estimate)) +
  geom_linerange(aes(ymin = lwr, ymax = upr), data = CI) +
  geom_point(aes(size = p), data = summary(tuk)) +
  scale_size(trans = "reverse") + theme_bw() + 
  coord_flip()
```




```{r echo=FALSE, fig.cap=fig$cap("scmd_lon_slope_elev", "Snow cover melting dates by Longitude, Slope and Elevation"), fig.height=6, fig.width=11}
x_lab <- xlab('Longitude')
y_lab <- ylab('Snow cover melting date (hydrological day)')

a <- ggplot(scmd1900, aes(x=lon, y= mean)) + 
  geom_point(col='gray') + 
  geom_smooth(method="lm", col="gray") +
  geom_smooth(method='loess') +
  theme_bw() + mythemeggplot + x_lab + y_lab
  

x_lab <- xlab('Slope (degrees)')  
b <- ggplot(scmd1900, aes(x=slope50mean_deg, y= mean)) + 
  geom_point(col='gray') + 
  geom_smooth(method="lm") +
  theme_bw() + mythemeggplot + x_lab + y_lab
  
x_lab <- xlab('Elevation (m)')  
c <- ggplot(scmd1900, aes(x=dem50mean, y= mean)) + 
  geom_point(col='gray') + 
  geom_smooth(method="lm") +
  theme_bw() + mythemeggplot + x_lab + y_lab 
  
grid.arrange(a, b, c, ncol=3)
```


## Snow Cover Melting Cycles

```{r, echo=FALSE}
# Subset data and classify elevation and aspect
scmc1900 <- scmc %>% filter(dem50mean > 1900) %>%
  mutate(dem50mean_group = cut(dem50mean, 
                         breaks = seq(from=0, to=3500, by=250),
                         labels = c("0-250", "251-500","501-750","751-1000",
                                    "1001-1250","1251-1500","1501-1750","1751-2000",
                                    "2001-2250","2251-2500","2501-2750", "2751-3000",
                                    "3001-3250", "3251-3500")),
         aspect50mean_deg_group = cut(aspect50mean_deg, 
                                      breaks= c(22.5, 67.5, 112.5, 157.5, 
                                                202.5, 247.5, 292.5, 337.5, 361),
                                      labels = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))) 


### Model 
m_scmc <- glm(mean ~ dem50mean + lon + aspect50mean_deg_group + slope50mean_deg, data=scmc1900)

# Remove na level of aspect 
df <- scmc1900 %>% na.omit() 

library("pander")
pander(format(tidy(drop1(m_scmc, test="Chi")), digits=4))
```


* What about the Variance Inflation factors? 


```{r, echo=FALSE}
# Exploring relationship
pander(as.data.frame(corvif(df[,c('dem50mean','lon','aspect50mean_deg_group','slope50mean_deg')])))
detach(package:pander, unload=TRUE)
```



```{r, message=FALSE, echo=FALSE, fig.cap=fig$cap("ggpair_scmc", "Explore relationships of covariates (Snow cover melting dates"), fig.height=12 , fig.width=11}
# Plot 
ggpairs(df, 
        columns = c("dem50mean","lon","aspect50mean_deg_group","slope50mean_deg"),
        columnLabels = c('Elevation','Longitude', 'Aspect', 'Slope'),
        lower = list(continuous = wrap(lowerFn, method="lm"),
                     combo = wrap("facethist", fill="blue")),
        upper = list(continuous = wrap("cor", size=11), combo='box'),
        diag = list(discrete = wrap("barDiag", fill= 'blue'))) +
   theme_bw() 
```        



```{r, echo=FALSE, fig.cap=fig$cap("scmc_tukey_aspect", "Snow cover melting dates by aspect"), fig.height=5 , fig.width=7, warning=FALSE, message=FALSE}
# Plot of Snow Cover Melting dates by aspect 

# Compute multiple comparisons 
tuk <- glht(m_scmc, linfct = mcp(aspect50mean_deg_group= "Tukey"))
# Convert comparisons into letters 
df_letter <- fortify(cld(tuk)) %>%
  transmute(aspect50mean_deg_group = as.factor(lhs),
         tukey_aspect = letters) 

# Plot 
ggplot(df, aes(x=aspect50mean_deg_group, y=mean)) +geom_boxplot() + 
  geom_text(data=df_letter, aes(label = tukey_aspect, x=aspect50mean_deg_group, y=5),
           position = position_dodge(width=0.9)) +
  theme_bw() + mythemeggplot +
  ylab('Snow cover melting cycles (n)') +
  xlab('aspect') 
```




```{r echo=FALSE, fig.cap=fig$cap("scmc_tukey_aspect_effects", "Snow cover melting dates by aspect (effect sizes"), fig.height=8 , fig.width=11}
# Effects comparison (aspect)
CI <- confint(tuk)

ggplot(mapping = aes(lhs, estimate)) +
  geom_linerange(aes(ymin = lwr, ymax = upr), data = CI) +
  geom_point(aes(size = p), data = summary(tuk)) +
  scale_size(trans = "reverse") + theme_bw() + 
  coord_flip()
```




```{r echo=FALSE, fig.cap=fig$cap("scmc_lon_slope_elev", "Snow cover melting dates by Longitude, Slope and Elevation"), fig.height=6, fig.width=11}
x_lab <- xlab('Longitude')
y_lab <- ylab('Snow cover melting cycles (n)')

a <- ggplot(scmc1900, aes(x=lon, y= mean)) + 
  geom_point(col='gray') + 
  geom_smooth(method='lm') +
  theme_bw() + mythemeggplot + x_lab + y_lab
  

x_lab <- xlab('Slope (degrees)')  
b <- ggplot(scmc1900, aes(x=slope50mean_deg, y= mean)) + 
  geom_point(col='gray') + 
  geom_smooth(method="lm") +
  theme_bw() + mythemeggplot + x_lab + y_lab
  
x_lab <- xlab('Elevation (m)')  
c <- ggplot(scmc1900, aes(x=dem50mean, y= mean)) + 
  geom_point(col='gray') + 
  geom_smooth(method="lm", col="gray") +
  geom_smooth(method="loess") +
  theme_bw() + mythemeggplot + x_lab + y_lab 
  
grid.arrange(a, b, c, ncol=3)
```



:red_circle: por aqui vas carpinto

```{r, echo=FALSE, eval=FALSE}
ggplot(df, aes(x=aspect, y=mean)) + 
  geom_bar(position=position_dodge(), stat="identity", fill='#084594') +
  geom_errorbar(aes(ymax = mean + sd, ymin=mean - sd),
                  width=.25, col= '#084594', 
                  position=position_dodge(.9)) + 
  theme_bw() + 
  ylab('Snow cover onset date (hydrological day)') +
  xlab('aspect') + 
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        strip.background=element_rect(fill='white')) 
```



# Cluster 
```{r, echo=FALSE}
# Prepare data 
df_scod <- scod %>% 
  select(nie_malla_modi_id, mean) %>% 
  mutate(scod = mean) %>% 
  select(-mean) 

df_scmd <- scmd %>% 
  select(nie_malla_modi_id, mean) %>% 
  mutate(scmd = mean) %>% 
  select(-mean) 

df <- scd %>% 
  select(nie_malla_modi_id, mean, dem50mean, basin_code, basin_name) %>% 
  mutate(scd = mean) %>% 
  select(-mean) %>%
  inner_join(df_scod, by='nie_malla_modi_id') %>%
  inner_join(df_scmd, by='nie_malla_modi_id')

rm(df_scmd, df_scod)

df_snow <- df %>% select(nie_malla_modi_id, dem50mean, scd, scod, scmd)

# All pixels
df_snow_full <- df_snow %>% select(-dem50mean)

# Only 1250 pixels 
df_snow_1250 <- df_snow %>% 
  dplyr::filter(dem50mean > 1250) %>% 
  dplyr::select(-dem50mean)
```


```{r}
# Cluster
## Full 
### Model based
clu_full <- Mclust(df_snow_full[,-1])
clu_full
summary(clu_full)
```

```{r, echo=FALSE, fig.cap=fig$cap("full_model_cluster", "Cluster Full Model"), fig.height=8 , fig.width=11}

### Plot 
#### BIC selection (n of clusters)
plot(clu_full, what= "BIC")

#### Classification (n of clusters)
plot(clu_full, what= "classification")

### Uncertainty
# plot(clu_full, what= "uncertainty")

# Save cluster into dataframe 
df_snow_full$clufull <- clu_full$classification
```


```{r, echo=FALSE, fig.cap=fig$cap("1250_model_cluster", "Cluster 1250 Model"), fig.height=8 , fig.width=11}
## 1250 
### Model based
clu_1250 <- Mclust(df_snow_1250[,-1])

clu_1250
summary(clu_1250)

### Plot 
#### BIC selection (n of clusters)
plot(clu_1250, what= "BIC")

#### Classification (n of clusters)
plot(clu_1250, what= "classification")

### Uncertainty
# plot(clu_1250, what= "uncertainty")

# Save cluster into dataframe 
df_snow_1250$clu1250 <- clu_1250$classification
aux <- df_snow_1250 %>% 
  select(nie_malla_modi_id, clu1250) 
```


```{r}
## Join all data
df_cluster <- df_snow_full %>% 
  left_join(aux, by = 'nie_malla_modi_id') 

df_cluster[is.na(df_cluster)]<- 0 


# spatial auxiliar
aux_spatial <- sp::merge(x=centroides_sn, y=df_cluster, by="nie_malla_modi_id")

# raster auxiliar 
aux_rast <- raster(aux_spatial, resolution=500)

# raster of cluster full 
clufull_raster <- rasterize(aux_spatial, aux_rast, "clufull")
names(clufull_raster) <- 'cluster'  


# raster of cluster 1250
clu1250_raster <- rasterize(aux_spatial, aux_rast, "clu1250")
names(clu1250_raster) <- 'cluster'  

# save 
writeRaster(clufull_raster, file=paste(di, "/data/derived/r_cluster_full.asc", sep=""), overwrite=TRUE)
writeRaster(clu1250_raster, file=paste(di, "/data/derived/r_cluster_1250.asc", sep=""), overwrite=TRUE)
```


```{r, echo=FALSE, fig.cap=fig$cap("raster_cluster_full", "Map of cluster (full)"), fig.height=8 , fig.width=11}

## Plot full 
# http://stackoverflow.com/questions/19136330/legend-of-a-raster-map-with-categorical-data
clufull_raster <- as.factor(clufull_raster)

rat <- levels(clufull_raster)[[1]]
rat[['cluster']] <- c('clu1','clu2', 'clu3', 'clu4', 'clu5')
levels(clufull_raster) <- rat 


mypal <- c('#7fc97f', '#beaed4', '#fdc086', '#ffff99', '#386cb0')

lp <- levelplot(clufull_raster, 
          margin=FALSE,
          col.regions=mypal,
          main="Cluster")

print(lp)
exportpdf(mypdf=paste0(di, '/images/raster_maps/r_cluster_1250.pdf'), lp) 
```


```{r, echo=FALSE, fig.cap=fig$cap("raster_cluster_1250", "Map of cluster (1250)"), fig.height=8 , fig.width=11}


  
## Plot 1250  
clu1250_raster <- as.factor(clu1250_raster)

rat <- levels(clu1250_raster)[[1]]
rat[['cluster']] <- c('nd','clu1','clu2', 'clu3', 'clu4', 
                      'clu5','clu6','clu7', 'clu8', 'clu9')
levels(clu1250_raster) <- rat 

mypal <- c('#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6','#d3d3d3')

lp <- levelplot(clu1250_raster, 
          margin=FALSE,
          col.regions=mypal,
          main="Cluster")


print(lp)
exportpdf(mypdf=paste0(di, '/images/raster_maps/r_cluster_1250.pdf'), lp) 
```












