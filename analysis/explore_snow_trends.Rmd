---
title: "Explore Trends of Snow Cover Related Indicators"
author: "AJ Perez-Luque (@ajpelu); FJ Bonet; J Herrero and R. Perez-Perez"
date: "2016 March"
output:  
    md_document:
      variant: markdown_github
      
---
## Prepare Data

1. Read data of Mann-Kendal Sen-Slope for each pixels and snow-cover related indicators (scd, scod, scmd, scmc). 
2. Read data of topographic variable: 
    + Convert radian to deg. 
    + Create categorical variable for elevation (250 m)
    + Classify aspect into 8 categories 
3. Read data from hydrological basin 
4. Read spatial data: 
    + Select only centroides of interest 
5. Create two dataframes: 
    + **Full Dataframe** with all variables and all pixels (`fulldf`)
    + **Filter dataframe** with all variables and filter by pixels above 1250 *m.a.s.l.* (`fulldf1250`)


```{r metadata, echo=FALSE}
# Set working directory 

machine <- 'ajpelu'
# machine <- 'ajpeluLap'
di <- paste('/Users/', machine, '/Dropbox/MS/CONGRESO_EGU2016/sn_snow_egu_2016', sep='')
```


```{r packages, warning=FALSE, echo=FALSE, message=FALSE}
# Load packages 
library("raster")
library("rgdal")
library("sp")
library("dplyr")
library("ggplot2")
library("reshape2")
library("multcomp")
```

```{r data}
# Trend analysis data
# Define name of indicators (see variables names)
indicadores <- c("scd", "scod", "scmd", "scmc")

# Loop to read files 
for (j in indicadores){ 
  aux <- read.csv(file=paste(di, "/data/derived/", j, ".csv", sep= ""),
              header = TRUE,
              sep = ',')
  assign(j, aux)
}
# --

# Define pixels of interes 
pixels_interes <- scd$nie_malla_modi_id

# Read Topographic data 
rawtopo <- read.csv(file=paste(di, "/data/topo_nie_malla_modis.csv", sep=""),
                    header=TRUE,
                    sep = ",") 

# function to convert radian to degree 
rad2deg <- function(rad) {(rad * 180) / (pi)} 


topo <- rawtopo %>% 
  filter(id %in% pixels_interes) %>% 
  mutate(nie_malla_modi_id = id, 
         slope50mean_deg = rad2deg(slope50mean),
         slope50median_deg = rad2deg(slope50median),
         aspect50mean_deg = rad2deg(aspect50mean),
         aspect50median_deg = rad2deg(aspect50median)) %>%
  dplyr::select(nie_malla_modi_id, dem50mean, dem50median, slope50mean_deg, 
                slope50median_deg, aspect50mean_deg, aspect50median_deg) 

## Create interval variables (250 m) for dem; and classify aspect into 8 categories 
topo <- topo %>% 
  mutate(dem50mean_group = cut(dem50mean, 
                         breaks = seq(from=0, to=3500, by=250),
                         labels = c("0-250", "251-500","501-750","751-1000",
                                    "1001-1250","1251-1500","1501-1750","1751-2000",
                                    "2001-2250","2251-2500","2501-2750", "2751-3000",
                                    "3001-3250", "3251-3500")),
         aspect50mean_deg_group = cut(aspect50mean_deg, 
                                      breaks= c(22.5, 67.5, 112.5, 157.5, 202.5, 247.5, 292.5, 337.5, 359.5),
                                      labels = c("N", "NE", "E", "SE", "S", "SW", "W", "NW")))


# --

# Read spatial data and Get lat/long
centroides <- rgdal::readOGR(dsn=paste(di, "/data/geoinfo", sep=""),
                             layer = "centroides_selected", verbose = FALSE)
# Select only attributes of interest and rename them
centroides <- centroides[c("id")]

# Create lat/lng by id 
xycentroides <- cbind(centroides@data, coordinates(centroides))
names(xycentroides) <- c("nie_malla_modi_id", "lon","lat")

xycentroides <- filter(xycentroides, nie_malla_modi_id %in% pixels_interes)
# -- 

# Hydrological basin 
basin <- read.csv(file=paste(di, "/data/derived/pixel_region.csv", sep=""),
                    header=TRUE,
                    sep = ",") 
# --


# Create un dataframe con todos los datos
fulldf <- topo %>% 
  inner_join(scod,  by=c("nie_malla_modi_id")) %>% 
  inner_join(scd,  by=c("nie_malla_modi_id")) %>% 
  inner_join(scmd,  by=c("nie_malla_modi_id")) %>% 
  inner_join(scmc,  by=c("nie_malla_modi_id")) %>% 
  inner_join(xycentroides, by="nie_malla_modi_id") %>%
  inner_join(basin, by="nie_malla_modi_id")

# Create subset of pixels above 1250 
fulldf1250 <- fulldf %>% 
  filter(dem50mean > 1250)  
```


# Explore Snow-Cover trends by basin 

We explore the pattern of snow-cover indicators trends by hydrological basin. 

```{r}
# Set theme ggplot options
mythemeggplot <- theme_bw() + theme(panel.grid.major=element_blank(),
                       panel.grid.minor=element_blank(),
                       strip.background=element_rect(fill='white'))
```

### Snow cover duration 

```{r}
## Summary statistics 
misvariables<- c('tau_scd', 'sen_slope_scd', 'tau_scod', 'sen_slope_scod',
                 'tau_scmd', 'sen_slope_scmd', 'tau_scmc', 'sen_slope_scmc')
variable_agrupa <- 'basin_name' 
prefijo  <- 'basin_' 
df <- fulldf1250

stats_basin <- data.frame() 
  
for (i in misvariables){
  vnames <- c(variable_agrupa, i)
  aux <- df %>%
    dplyr::select(one_of(vnames)) %>%
    mutate_(vinterest = i) %>%
    group_by_(.dots=variable_agrupa) %>%
    summarise(mean=mean(vinterest),
              sd = sd(vinterest),
              se = sd / sqrt (length(vinterest)))
  aux <- aux %>% 
    mutate(variable = i)
  
  stats_basin <- rbind(stats_basin, aux)
  # assign(paste0(prefijo,i), aux)
   
}
```

Analyze differences in trends statistics between hydrological basins

### Snow cover duration

```{r}
df_letter_aux <- data.frame() 
df <- fulldf1250
```

```{r}
# Tau scd 
# ANOVA 
variable <- 'tau_scd'
my_ylab <- 'Tau Snow cover duration'
mod <- aov(tau_scd ~ basin_name, data=df)

## Multiple comparisons 
tuk <- glht(mod, linfct = mcp(basin_name = "Tukey"))
# Convert comparisons into letters 
df_letter <- fortify(cld(tuk)) %>%
  transmute(basin_name = as.factor(lhs),
         tukey_basin_name = letters) %>%
  mutate(variable = variable)

df_letter_aux <- rbind(df_letter_aux, df_letter)

## ANOVA plots
ggplot(df, aes_string(x='basin_name', y=variable)) + 
  geom_boxplot() +
  geom_text(data=df_letter, aes(label = tukey_basin_name, x=basin_name, y=0.5),
           position = position_dodge(width=0.9)) +
  theme_bw() + mythemeggplot + 
  ylab(my_ylab) + xlab('')
```


```{r}
# Sen scd 
# ANOVA 
variable <- 'sen_slope_scd'
my_ylab <- 'Sen slope Snow cover duration'
mod <- aov(sen_slope_scd ~ basin_name, data=df)

## Multiple comparisons 
tuk <- glht(mod, linfct = mcp(basin_name = "Tukey"))
# Convert comparisons into letters 
df_letter <- fortify(cld(tuk)) %>%
  transmute(basin_name = as.factor(lhs),
         tukey_basin_name = letters) %>%
  mutate(variable = variable)

df_letter_aux <- rbind(df_letter_aux, df_letter)

## ANOVA plots
ggplot(df, aes_string(x='basin_name', y=variable)) + 
  geom_boxplot() +
  geom_text(data=df_letter, aes(label = tukey_basin_name, x=basin_name, y=4.5),
           position = position_dodge(width=0.9)) +
  theme_bw() + mythemeggplot + 
  ylab(my_ylab) + xlab('')
```


# Snow cover onset date

```{r}
# Tau scod 
# ANOVA 
variable <- 'tau_scod'
my_ylab <- 'Tau Snow cover onset date'
mod <- aov(tau_scod ~ basin_name, data=df)

## Multiple comparisons 
tuk <- glht(mod, linfct = mcp(basin_name = "Tukey"))
# Convert comparisons into letters 
df_letter <- fortify(cld(tuk)) %>%
  transmute(basin_name = as.factor(lhs),
         tukey_basin_name = letters) %>%
  mutate(variable = variable)

df_letter_aux <- rbind(df_letter_aux, df_letter)

## ANOVA plots
ggplot(df, aes_string(x='basin_name', y=variable)) + 
  geom_boxplot() +
  geom_text(data=df_letter, aes(label = tukey_basin_name, x=basin_name, y=0.7),
           position = position_dodge(width=0.9)) +
  theme_bw() + mythemeggplot + 
  ylab(my_ylab) + xlab('')
```


```{r}
# Sen scod 
# ANOVA 
variable <- 'sen_slope_scod'
my_ylab <- 'Sen slope Snow cover onset date'
mod <- aov(sen_slope_scod ~ basin_name, data=df)

## Multiple comparisons 
tuk <- glht(mod, linfct = mcp(basin_name = "Tukey"))
# Convert comparisons into letters 
df_letter <- fortify(cld(tuk)) %>%
  transmute(basin_name = as.factor(lhs),
         tukey_basin_name = letters) %>%
  mutate(variable = variable)

df_letter_aux <- rbind(df_letter_aux, df_letter)

## ANOVA plots
ggplot(df, aes_string(x='basin_name', y=variable)) + 
  geom_boxplot() +
  geom_text(data=df_letter, aes(label = tukey_basin_name, x=basin_name, y=10),
           position = position_dodge(width=0.9)) +
  theme_bw() + mythemeggplot + 
  ylab(my_ylab) + xlab('')
```

# Snow cover melting date






```{r}
ggplot(fulldf1250, aes(y=tau_scd, x=basin_name)) + geom_boxplot() +
  mythemeggplot + xlab('') + ylab('Tau (Snow cover duration)') 









ggplot(fulldf1250, aes(y=tau_scd, x=basin_name)) + geom_boxplot() +
  mythemeggplot + xlab('') + ylab('Tau (Snow cover duration)') 


ggplot(fulldf1250, aes(y=tau_scd, x=basin_name)) + geom_boxplot() +
  mythemeggplot + xlab('') + ylab('Tau (Snow cover duration)') + 
  facet_wrap(~dem50mean_group) + 
  geom_hline(yintercept=0, col='grey') 


ggplot(fulldf1250, aes(y=sen_slope_scd, x=basin_name)) + geom_boxplot() +
  mythemeggplot + xlab('') + ylab('Tau (Snow cover duration)') 

ggplot(fulldf1250, aes(y=sen_slope_scd, x=basin_name)) + geom_boxplot() +
  mythemeggplot + xlab('') + ylab('Tau (Snow cover duration)') + 
  facet_wrap(~dem50mean_group) + 
  geom_hline(yintercept=0, col='grey') 




ggplot(fulldf, aes(x=tau_scod, y=tau_scmd)) + 
  geom_point(alpha=0.5) + 
  xlim(-1,1) + ylim(-1,1) + 
  geom_vline(xintercept=0) +
  geom_hline(yintercept=0) + 
  annotate('text', label='early',  x=-.9, y=-.9) + 
  annotate('text', label='late', x=.9, y=.9)+
  annotate('text', label='contraction', x=.9, y=-.9)+
  annotate('text', label='expansion', x=-.9, y=.9) + 
  theme_bw() + 
  labs(title= 'scod vs. scmd',
    x= 'trend (tau) of Snow cover onset date',
    y='trend (tau) of Snow cover melting date') 








## Explore Snow-cover related indicators

We explore the pattern of the trend (*tau*) of the snow-cover indicators (see figure 1). 

By exploring the relationship between the trend of two indicators of snow cover (scod: snow cover onset date; and scmd: snow cover melting date) we can describe the temporal evolution of snow cover in Sierra Nevada from 2000-2014. This relationship is evaluated at pixel scale (figure 1c) and we have four potential scenarios:

* Expansion
* Contraction
* Shift (delay and advance)

**Figure 1**
![Figure 1.](/images/snow_cover_profile.png) 

We applied this exploratory analysis for all pixels and for all pixels above 1900 *m asl*. 

```{r fig.cap='Figure 2', echo=FALSE}
# Exploratory for all pixels 
ggplot(fulldf, aes(x=tau_scod, y=tau_scmd)) + 
  geom_point(alpha=0.5) + 
  xlim(-1,1) + ylim(-1,1) + 
  geom_vline(xintercept=0) +
  geom_hline(yintercept=0) + 
  annotate('text', label='early',  x=-.9, y=-.9) + 
  annotate('text', label='late', x=.9, y=.9)+
  annotate('text', label='contraction', x=.9, y=-.9)+
  annotate('text', label='expansion', x=-.9, y=.9) + 
  theme_bw() + 
  labs(title= 'scod vs. scmd',
    x= 'trend (tau) of Snow cover onset date',
    y='trend (tau) of Snow cover melting date') 
```
  
```{r fig.cap='Figure 3', echo=FALSE}  
# Exploratory for pixels >1900
ggplot(fulldf1900, aes(x=tau_scod, y=tau_scmd)) + 
  geom_point(alpha=0.5) + 
  xlim(-1,1) + ylim(-1,1) + 
  geom_vline(xintercept=0) +
  geom_hline(yintercept=0) + 
  annotate('text', label='early',  x=-.9, y=-.9) + 
  annotate('text', label='late', x=.9, y=.9)+
  annotate('text', label='retraction', x=.9, y=-.9)+
  annotate('text', label='expansion', x=-.9, y=.9) + 
  theme_bw() + 
  labs(title= 'scod vs. scmd (>1900 masl)',
    x= 'trend (tau) of Snow cover onset date',
    y='trend (tau) of Snow cover melting date') 
```

```{r, echo=FALSE}
aux <- round(((fulldf1900 %>% filter(tau_scod > 0) %>% filter(tau_scmd < 0) %>% count()) / fulldf1900 %>% count())*100, 2)
```

A total of `r aux` % of pixels (of all above 1900) showed a positive trend in snow cover onset date (late onset) and a negative trend in snow cover melting date (earlier melting date). It means that of `r aux` % of the pixels above 1900 m, have suffered a trend to rectraction of the snow cover period in the last years (Figure 3). 

We also can explore this relationship by elevation (Figure 4), and we obtanied that the *retraction pattern* is more evident at low elevations 

```{r, fig.cap='Figure 4', fig.height=10, fig.width=8, echo=FALSE}
# Exploratory by elevatin groups 
ggplot(fulldf1900, aes(x=tau_scod, y=tau_scmd)) + 
  geom_point(alpha=0.5) + 
  xlim(-1,1) + ylim(-1,1) + 
  geom_vline(xintercept=0) +
  geom_hline(yintercept=0) + 
  facet_wrap(~dem50mean_group) + 
  theme_bw() + 
  labs(title= 'scod vs. scmd (>1900 masl)',
       x= 'trend (tau) of Snow cover onset date',
       y='trend (tau) of Snow cover melting date') +
  theme(strip.background = element_rect(fill = "white"))
```

```{r, results='asis'}
# Compute percentage of pixels (tau scod > 0, tau_scmd < 0)   
aux <- fulldf1900 %>% group_by(dem50mean_group) %>% 
  summarise(total=n())

aux1 <- fulldf1900 %>% group_by(dem50mean_group) %>% 
  filter(tau_scod > 0) %>% 
  filter(tau_scmd < 0) %>% 
  summarise(n=n()) %>%
  inner_join(aux, by="dem50mean_group") %>%
  mutate(freq = round((n / total)*100),2)
pander(aux1)
```

First we explore the relationship between topographic variables and snow-cover related variables. 

## Notas
(see Chen et al. 2015)
* Dd <- duration of snow cover 
* Do <- day of onset 
* De <- day of end 

Analysis of the spatio-temporal pattern of this variables 

### Elevation pattern

```{r}
# Compute mean, sd, se of tau variables by elevation interval and plot them 
taus <- fulldf1900 %>% 
  select(contains("tau"), dem50mean_group) 
taus <- melt(taus, id=c("dem50mean_group"))

taus <- taus %>% 
  group_by(dem50mean_group, variable) %>% 
  summarise(mean = mean(value),
            sd = sd(value),
            se=sd(value)/sqrt(length(value)))

ggplot(taus, aes(x=dem50mean_group, y=mean, group=variable)) +
  geom_line() + geom_errorbar(aes(ymax = mean + se, ymin= mean - se), width=.15) +
  geom_point(size=3, shape=21, fill="white") +
  facet_wrap(~variable) +
  theme_bw() + xlab('elevation') + ylab('tau (average value)') +
  theme(axis.text.x=element_text(angle = -90, hjust = 0))


# Explore trends of temperatures and snow-cover indicators potentially related with temperature
df <- taus %>% filter(variable %in% c("tau_scod","tau_scmd", "tau_scd", "tau_temp"))

ggplot(df, aes(x=dem50mean_group, y=mean, group=variable)) +
  geom_line(aes(col=variable)) + 
  geom_errorbar(aes(col=variable, ymax = mean + se, ymin= mean - se), width=.15) +
  geom_point(aes(col=variable), size=3, shape=21, fill="white") + 
  theme_bw() + xlab('elevation') + ylab('tau (average value)') +
  theme(axis.text.x=element_text(angle = -90, hjust = 0))
 

# Explore trends of temperatures and snow-cover indicators potentially related with temperature
df <- taus %>% filter(variable %in% c("tau_scod","tau_scmd", "tau_scd", "tau_pre_snow"))

ggplot(df, aes(x=dem50mean_group, y=mean, group=variable)) +
  geom_line(aes(col=variable)) + 
  geom_errorbar(aes(col=variable, ymax = mean + se, ymin= mean - se), width=.15) +
  geom_point(aes(col=variable), size=3, shape=21, fill="white") + 
  theme_bw() + xlab('elevation') + ylab('tau (average value)') +
  theme(axis.text.x=element_text(angle = -90, hjust = 0))


####

# Compute mean, sd, se of tau variables by elevation interval and plot them 
sen <- fulldf1900 %>% 
  select(contains("sen_slope"), aspect50mean_deg) %>%
  select(-contains("slope_per")) %>% 
  mutate(aspect50mean_deg_group = cut(aspect50mean_deg, 
    breaks= c(22.5, 67.5, 112.5, 157.5, 202.5, 247.5, 292.5, 337.5, 359.5),
    labels = c("N", "NE", "E", "SE", "S", "SW", "W", "NW")))

taus <- fulldf1900 %>% 
  select(contains("tau"), aspect50mean_deg) %>%
  mutate(aspect50mean_deg_group = cut(aspect50mean_deg, 
    breaks= c(22.5, 67.5, 112.5, 157.5, 202.5, 247.5, 292.5, 337.5, 359.5),
    labels = c("N", "NE", "E", "SE", "S", "SW", "W", "NW")))

plot(taus$tau_scmd~taus$aspect50mean_deg_group, col='grey')
abline(lm(taus$tau_scod~taus$aspect50mean_deg))

plot(taus$tau_scd~taus$aspect50mean_deg, col='grey')
abline(lm(taus$tau_scd~taus$aspect50mean_deg))









sen <- melt(sen, id=c("dem50mean_group"))

sen <- sen %>% 
  group_by(dem50mean_group, variable) %>% 
  summarise(mean = mean(value),
            sd = sd(value),
            se=sd(value)/sqrt(length(value)))

ggplot(sen, aes(x=dem50mean_group, y=mean, group=variable)) +
  geom_line() + geom_errorbar(aes(ymax = mean + se, ymin= mean - se), width=.15) +
  geom_point(size=3, shape=21, fill="white") +
  facet_wrap(~variable) +
  theme_bw() + xlab('elevation') + ylab('tau (average value)') +
  theme(axis.text.x=element_text(angle = -90, hjust = 0))






)## Analysis of the correlation between taus. 

### Relation between *scod* and *scmd* 



## Explore Slopes 

```{r, fig.height=10, fig.width=8}
# Exploratory for pixels >1900
ggplot(fulldf1900, aes(x=sen_slope_scod, y=sen_slope_scmd)) +
  geom_point(alpha=0.5) + 
  xlim(-7.5,7.5) + ylim(-7.5,7) + 
  geom_vline(xintercept=0) + geom_hline(yintercept=0) + 
  theme_bw() + 
  labs(title= 'scod vs. scmd (>1900 masl)',
       x= 'Slope (days) of Snow cover onset date',
       y='Slope (days) of Snow cover melting date') 

# by elevation group 
ggplot(fulldf1900, aes(x=sen_slope_scod, y=sen_slope_scmd)) + 
  geom_point(alpha=0.5) + 
  xlim(-7.5,7.5) + ylim(-7.5,7) +
  geom_vline(xintercept=0) +
  geom_hline(yintercept=0) +
  labs(title= 'scod vs. scmd (>1900 masl)',
       x= 'Slope (days) of Snow cover onset date',
       y='Slope (days) of Snow cover melting date') +
  theme_bw() + 
  theme(strip.background = element_rect(fill = "white")) +
  facet_wrap(~dem50mean_group)

```







```{r, eval=FALSE, echo=FALSE}
# Create a subset for only taus 

taus <- fulldf %>%
  dplyr::select(nie_malla_modi_id, 
                dem50mean,
                starts_with("tau"))


tau1900 <- fulldf %>% 
  filter(elevacion > 1900) %>% 
  dplyr::select(nie_malla_modi_id, elevacion, elevGroup, starts_with("tau"))


















  

### Create subset of data > 1900 elev and only taus

taus <- fulldf %>%
  dplyr::select(nie_malla_modi_id, 
                elevacion,
                starts_with("tau"))


tau1900 <- fulldf %>% 
  filter(elevacion > 1900) %>% 
  dplyr::select(nie_malla_modi_id, elevacion, elevGroup, starts_with("tau"))

ss1900 <- fulldf %>% 
  filter(elevacion > 1900) %>% 
  dplyr::select(nie_malla_modi_id, elevacion, elevGroup, starts_with("sen_slope"))

tau <- fulldf %>% 
  dplyr::select(nie_malla_modi_id, elevacion, elevGroup, starts_with("tau"))



plot(tau1900)



ggplot(tau, aes(tau_temp, tau_scmd)) + geom_point() + 
  facet_wrap(~elevGroup)

ggplot(tau1900, aes(elevacion,tau_scd)) + geom_point()
  geom_point(aes(colour=elevGroup))
  
ggplot(ss1900, aes(elevacion,sen_slope_pre_snow_per)) + geom_point()
















# # Loop to add elevation data and to create subsets with elevation > 1900 
# for (k in indicadores){
#   auxmk <- get(k) # Get object
#   aux_elev <- inner_join(elev, auxmk, by="nie_malla_modi_id") # Join elevation data
#   
#   aux_elev1900 <- aux_elev %>% filter(elevacion > 1900)
#   
#   assign(k, aux_elev)
#   assign(paste(k,'1900',sep=''), aux_elev1900)
#   }
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
#   
#   
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# # Asignamos proyección al raster anterior
# crs(raster_tendencia)<-"+proj=utm +zone=30"
# 
# # reproyectar a geográficas
# raster_tendencia<-projectRaster(raster_tendencia, crs = "+proj=longlat")
# 
# # creamos máscara para recortar y remuestrear. Le ponemos la resolución y la extensión de raster_tendencia
# mascara<-raster(crs = "+proj=longlat")
# extent(mascara)<-extent(raster_tendencia)
# res(mascara)<-c(0.00418,0.00418)
# 
# raster_tendencia<-resample(raster_tendencia, mascara)
# plot(raster_tendencia)
# 
# 
# 
# 
# plot(mm1)
# 
# 
# 
# head(pixels)
# summary(pixels)
# 
# extent(pixels)
# projection(pixels)
# 
# 
# head(pixels)
```






