---
title: "Compute Mann-Kendall Theil Sen of Precipitation"
author: "AJ Perez-Luque (@ajpelu); FJ Bonet; J Herrero and R. Perez-Perez and "
date: "2016 Jaunary"
output:  
    md_document:
      variant: markdown_github
---

```{r metadata, echo=FALSE}
########################################################
# Title: Compute Mann-Kendall Theil Sen of snow cover
# Date: Feb 2015
# version: v1
# Authors: Perez-Luque AJ (@ajpelu); Perez-Perez R and Bonet FJ 
################################################################

################################################################
# Set working directory 
machine <- 'ajpelu'
# machine <- 'ajpeluLap'
di <- paste('/Users/', machine, '/ownCloud/MS/CONGRESO_EGU2016/sn_snow_egu_2016', sep='')
################################################################
```

En primer lugar leemos los datos
```{r packages, warning=FALSE}
################################################################
# Load packages 
library('wq')
library('reshape2')
################################################################

################################################################
# Read data
raw_pre <- read.csv(file=paste(di, '/data/PXpxXyear.csv', sep=''), header=T, sep=',')

# Remove NaN
prec <- raw_pre[which(!is.na(raw_pre$pre)),]

# Rename 
names(prec) <- c('nie_malla_modi_id', 'pre', 'year')
                
################################################################
```

A continuación creamos un bucle para obtener de cada indicador la tendencia y la pendiente. Aplicamos la técnica de Mann-Kendall-Theil-Sen. El bucle realiza las siguientes operaciones: 

* Crea una variable con los indicadores para el bucle. 
* Realiza un subset de datos con los valores del indicador para cada pixel. Obtenemos una serie de datos por cada pixel. 
* Calculamos la tendencia y la pendiente
* Guardamos los resultamos como csv (uno por cada indicador, ver `./data/`)

```{r}


aux <- dcast(prec, year ~ nie_malla_modi_id, value.var = pre) 


################################################################
# Loop to compute the MKT by indicator

# Define name of indicators (see variables names)
indicadores <- c('scd', 'scod', 'scmd', 'scmc' )

# subset by indicator
for (j in indicadores){ 
  # Create a subset by indicator
  subdf <- snow[, names(snow) %in% c('nie_malla_modi_id', 'ano', j )]
  
  # Manipule data. Transpose 
  # la funcion aggregate es porque tenemos duplicados 
  aux <- dcast(subdf, ano ~ nie_malla_modi_id, value.var = j, fun.aggregate = mean) 

  # Create a zoo object 
  auxts <- zoo(aux[-1],aux[,1])
  
  # Compute Mann Kendall and Theil 
  theil <- mannKen(as.ts(auxts))
  
  # Prepare data output
  theil <- as.data.frame(theil)
  theil$nie_malla_modi_id <- rownames(theil)
  
  # Round the output
  theil$sen.slope <- round(theil$sen.slope, 3)
  theil$sen.slope.pct <- round(theil$sen.slope.pct,2)
  theil$p.value <- round(theil$p.value, 5)
  theil$varS <- round(theil$varS, 2)
  theil$tau <- round(theil$tau, 3)
  
  # Assign output to an dataframe
  assign(j, theil)
  
  # Write table 
  write.table(assign(j, theil), file=paste(di, '/data/', j, '.csv', sep=''), row.names=FALSE, sep=';')
  
  # Check Results. Get the pixel with NA in pvalue. Save results
  aux_na <- theil[!complete.cases(theil),]
  aux_na$var <- rep(j,nrow(aux_na))
  write.table(aux_na[,c(8:9)], file=paste(di, '/data/na_', j, '.csv', sep=''), row.names=FALSE, sep=';')
    
} 
################################################################
```
